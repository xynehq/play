#!/usr/bin/env python3

import argparse
import sys
from pathlib import Path

# Add current directory to path to import orchestrator
sys.path.insert(0, str(Path(__file__).parent))

from orchestrator import run_pr


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Run PR automation pipeline with automated Stage 0 (PR setup)",
        epilog="""
Examples:
  # Run with specific models (REQUIRED)
  ./run_pr 9298 --models glm-full
  
  # Run with multiple models (comma-separated)
  ./run_pr 9298 --models minimax-m2,glm-full
  
  # Skip Stage 0 if PR setup was done manually via pr_analyzer.sh
  ./run_pr 9298 --models glm-full --skip-setup
  
  # CLI-driven execution model selection
  python3 run_pr 9298 --models claude-3-5-sonnet-20241022
        """
    )
    parser.add_argument("pr_number", help="PR number to process")
    parser.add_argument(
        "--models",
        required=True,
        help="Comma-separated list of execution models (REQUIRED). "
             "Each model will execute the prompts generated by minimaxai/minimax-m2. "
             "Example: --models glm-full or --models claude-3-5-sonnet-20241022",
    )
    parser.add_argument(
        "--skip-setup",
        action="store_true",
        help="Skip Stage 0 (PR setup). Use if you already ran pr_analyzer.sh manually",
    )
    args = parser.parse_args()
    
    # Validate models parameter
    if not args.models.strip():
        parser.error("--models parameter is required and cannot be empty")
    
    return args


def main():
    """Main CLI entry point for run_pr command."""
    args = parse_args()
    
    # Parse models from comma-separated string
    models = [model.strip() for model in args.models.split(",") if model.strip()]
    
    if not models:
        print("ERROR: No valid models provided. Use --models to specify execution models.")
        sys.exit(1)
    
    print(f"CLI-driven execution: {len(models)} model(s) selected")
    for i, model in enumerate(models, 1):
        print(f"  {i}. {model}")
    
    run_pr(args.pr_number, models=models, skip_setup=args.skip_setup)


if __name__ == "__main__":
    main()
